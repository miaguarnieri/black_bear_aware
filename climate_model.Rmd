---
title: "climate_model"
author: "Chase Tarr"
date: "10/31/2022"
output: html_document
---

##Setup and packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#attach packages
library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(lubridate)
library(ResourceSelection)
library(rmapshaper)

#mia, chase, and claire's file path

gdrive_data <- "/Volumes/GoogleDrive/Shared drives/Black_Bear_Aware/gdrive_data"

#sam's file path
#gdrive_data <- "G:/Shared drives/Black_Bear_Aware/gdrive_data"

```

#Load in data layers

```{r}
#conflict data
conflict_buffers <- read_sf(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/conflict_buffered_refined/conflict_buffered_refined.shp"))

conflict_points <- read_sf(here(gdrive_data, "/IntermediateData/IntermediateData_Files/conflict_formatted/conflict_points/conflict_points.shp"))

#elevation
dem <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/elevation/dem_formatted.tif"))

#aspect
aspect <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/aspect/aspect.tif"))

#terrain ruggedness
ter_rug <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/terrain_ruggedness/terrain_ruggedness.tif"))

#human pop density

pop16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2016_mask.tif"))

pop17 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2017_mask.tif"))

pop18 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2018_mask.tif"))

pop19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2019_mask.tif"))

pop20 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2020_mask.tif"))

pop21 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2021_mask.tif"))

#land cover

lc13 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc13_reclassed.tif"))

lc16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc16_reclassed.tif"))

lc19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc19_reclassed.tif"))

#road density

road_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/road_density/road_density_ca.tif"))

#distance to roads

road_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_road/model_ready/roads15_ca_distance.tif"))

#distance to streams

streams_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_stream/model_ready/stream17_ca_distance.tif"))

#distance to urban areas

urban_dist_13 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua13_ca_distance.tif"))

urban_dist_16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua16_ca_distance.tif"))

urban_dist_19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua19_ca_distance.tif"))

#distance to recreational areas

rec_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_rec/model_ready/rec_ca_distance.tif"))

#distance to forest cover

fc_dist_13 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc13_ca_distance.tif"))

fc_dist_16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc16_ca_distance.tif"))

fc_dist_19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc19_ca_distance.tif"))

#forest density

fdens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/forest_density/forest_dens_2016_mask.tif"))

#drought current - historical

drought_2016 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2016/d2016_masked.tif"))

drought_2017 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2017/d2017_masked.tif"))

drought_2018 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2018/d2018_masked.tif"))

drought_2019 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2019/d2019_masked.tif"))

drought_2020 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2020/d2020_masked.tif"))

drought_2021 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2021/d2021_masked.tif"))

#fire

dist_fire11_12 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire11_12_ca_distance.tif"))

dist_fire12_13 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire12_13_ca_distance.tif"))

dist_fire13_14 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire13_14_ca_distance.tif"))

dist_fire14_15 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire14_15_ca_distance.tif"))

dist_fire15_16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire15_16_ca_distance.tif"))

dist_fire16_17 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire16_17_ca_distance.tif"))

dist_fire17_18 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire17_18_ca_distance.tif")) 

dist_fire18_19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire18_19_ca_distance.tif"))

dist_fire15 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire15_ca_distance.tif"))

dist_fire16 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire16_ca_distance.tif"))

dist_fire17 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire17_ca_distance.tif"))

dist_fire18 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire18_ca_distance.tif"))

dist_fire19 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire19_ca_distance.tif"))

dist_fire20 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire20_ca_distance.tif"))

```


#Process data by year

##2016

```{r}

#extract values for 2016, select only conflict indicator and geometry

con_16 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2016) %>% 
  select(conflict, geometry)

con_16_buff <- conflict_buffers %>% 
  filter(year == 2016) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra

conpoints_16_sv <- vect(con_16)

conbuff_16_sv <- vect(con_16_buff)

#read in the CA raster
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure conflict is in the same projection
conpoints16_reproj <- project(conpoints_16_sv,crs(ca_raster))

conbuff16_reproj <- project(conbuff_16_sv,crs(ca_raster))

#convert back to sf for creation of inverse mask
conpoints16_sf <- st_as_sf(conpoints16_reproj)

conbuff16_sf <- st_as_sf(conbuff16_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out

conbuff16_inverse <- mask(ca_raster, conbuff16_reproj, inverse = TRUE)

tm_shape(conbuff16_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 
cabuff16_inv_pol <- as.polygons(conbuff16_inverse)

cabuff16_inv_sf <- st_as_sf(cabuff16_inv_pol)

#sampling random points from this misshapen california shpfile
sample16 <- st_sample(cabuff16_inv_sf, 2135) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample16) +
  tm_dots() +
  tmap_mode("view")

#remove the intersecting polygons

climzeros16 <- ms_erase(target = sample16, erase = conbuff16_sf)
 
 #plot to check that there is no overlap
 
 tm_shape(conbuff16_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros16) +
   tm_dots() +
  tmap_mode("view")

zeros16_formatted <- zeros16 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

climstack16 <- c(dem, aspect, ter_rug, pop16, lc16, road_dens, road_dist, streams_dist, urban_dist_16, rec_dist, fc_dist_16, fdens, dist_fire15, dist_fire13_14, dist_fire11_12, drought_2016)

#extract data points from these rasters and convert them to a dataframe

#first nonconflict points

clim_zero_vars16 <- extract(stack16, zeros16_formatted, method = "simple", bind = TRUE, ID = TRUE) %>%
  as.data.frame()

#then conflict points

con_vars16 <- extract(stack16, con_16, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame()

#combine conflict and non-conflict points (need to rename columns first to match - colnames MUST be in same order as raster stack in order to line up correctly with the data)

colnames(zero_vars16) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs","drought")

colnames(con_vars16) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

clim_model_df_16 <- rbind(zero_vars16, con_vars16)

#label the year for later binding with other dfs

clim_modeldf_16_year <- model_df_16 %>% 
  mutate(year = 2016)

```

```{r}
#saving the files

write.csv(modeldf_16_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/climate_modeldf_16.csv"), row.names = FALSE)

```


##2017

```{r}
#extract values for 2017, select only conflict indictor and geometry, and dissolve polygons
con_17 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2017) %>% 
  select(conflict, geometry)

con_17_buff <- conflict_buffers %>% 
  filter(year == 2017) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra

conpoints_17_sv <- vect(con_17)
conbuff_17_sv <- vect(con_17_buff)

#read in the CA raster 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#reproject the conflict data 
conpoints17_reproj <- project(conpoints_17_sv, crs(ca_raster))

conbuff17_reproj <- project(conbuff_17_sv, crs(ca_raster))

conpoints17_sf <- st_as_sf(conpoints17_reproj)
conbuff17_sf <- st_as_sf(conbuff17_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out
conbuff17_inverse <- mask(ca_raster, conbuff17_reproj, inverse = TRUE)
tm_shape(conbuff17_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 
cabuff17_inv_pol <- as.polygons(conbuff17_inverse)
cabuff17_inv_sf <- st_as_sf(cabuff17_inv_pol)

#sampling random points from this misshapen california shpfile
sample17 <- st_sample(cabuff17_inv_sf, 669) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample17) +
  tm_dots() +
  tmap_mode("view")

#remove the intersecting polygons
zeros17 <- ms_erase(target = sample17, erase = conbuff17_sf)
 
 #plot to check that there is no overlap
 
tm_shape(conbuff17_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros17) +
   tm_dots() +
  tmap_mode("view")
 
zeros17_formatted <- zeros17 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

stack17 <- c(dem, aspect, ter_rug, pop17, lc16, road_dens, road_dist, streams_dist, urban_dist_16,rec_dist,fc_dist_16, fdens, dist_fire16, dist_fire14_15, dist_fire12_13, drought_2017)

#extract data points from these rasters and convert them to a dataframe

#first nonconflict points
zero_vars17 <- extract(stack17, zeros17_formatted, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame()

#then conflict points
con_vars17 <- extract(stack17, con_17, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame()

#combine conflict and non-conflict

colnames(zero_vars17) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

colnames(con_vars17) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

model_df_17 <- rbind(zero_vars17, con_vars17)

#label the year for later binding with other dfs
modeldf_17_year <- model_df_17 %>% 
  mutate(year = 2017) %>% 
  as.data.frame()

```

```{r}
#save the file

write.csv(modeldf_17_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_17.csv"), row.names = FALSE)

```

##2018
```{r}
#extract values for 2018, select only conflict indicator and geometry, and dissolve polygons

con_18 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2018) %>% 
  select(conflict, geometry)

con_18_buff <- conflict_buffers %>% 
  filter(year == 2018) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra

conpoints_18_sv <- vect(con_18)

conbuff_18_sv <- vect(con_18_buff)

#read in the CA raster
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure conflict is in the same projection
conpoints18_reproj <- project(conpoints_18_sv,crs(ca_raster))

conbuff18_reproj <- project(conbuff_18_sv,crs(ca_raster))

conpoints18_sf <- st_as_sf(conpoints18_reproj)

conbuff18_sf <- st_as_sf(conbuff18_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out

conbuff18_inverse <- mask(ca_raster, conbuff18_reproj, inverse = TRUE)

tm_shape(conbuff18_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 
cabuff18_inv_pol <- as.polygons(conbuff18_inverse)

cabuff18_inv_sf <- st_as_sf(cabuff18_inv_pol)


#sampling random points from this misshapen california shpfile
sample18 <- st_sample(cabuff18_inv_sf, 727) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample18) +
  tm_dots() +
  tmap_mode("view")


#remove the intersecting polygons

zeros18 <- ms_erase(target = sample18, erase = conbuff18_sf)
 
 #plot to check that there is no overlap
 
 tm_shape(conbuff18_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros18) +
   tm_dots() +
  tmap_mode("view")

zeros18_formatted <- zeros18 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

stack18 <- c(dem, aspect, ter_rug, pop18, lc16, road_dens, road_dist, streams_dist, urban_dist_16, rec_dist, fc_dist_16, fdens, dist_fire17, dist_fire15_16, dist_fire13_14)

#extract data points from these rasters and add them to the shapefile dataframe

#nonconflict points
zero_vars18 <- extract(stack18, zeros18_formatted, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame()

#union conflict points before extracting
con_union18 <- con_18 %>% 
  st_union() %>% 
  vect()

con_vars18 <- extract(stack18, con_union18, method = "simple", bind = TRUE, ID = TRUE)

#combine conflict and non-conflict

colnames(zero_vars18) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

colnames(con_vars18) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

model_df_18 <- rbind(zero_vars18, con_vars18)

#label the year for later binding with other dfs
modeldf_18_year <- model_df_18 %>% 
  mutate(year = 2018)
```

```{r}
#save the file

write.csv(modeldf_18_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_18.csv"), row.names = FALSE)
```

##2019

```{r}
#extract values for 2016, select only conflict indicator and geometry, and dissolve polygons
con_19 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2019) %>% 
  select(conflict, geometry)

con_19_buff <- conflict_buffers %>% 
  filter(year == 2019) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra

conpoints_19_sv <- vect(con_19)

conbuff_19_sv <- vect(con_19_buff)

#read in the CA raster
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure conflict is in the same projection
conpoints19_reproj <- project(conpoints_19_sv,crs(ca_raster))

conbuff19_reproj <- project(conbuff_19_sv,crs(ca_raster))

conpoints19_sf <- st_as_sf(conpoints19_reproj)

conbuff19_sf <- st_as_sf(conbuff19_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out

conbuff19_inverse <- mask(ca_raster, conbuff19_reproj, inverse = TRUE)

tm_shape(conbuff19_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 
cabuff19_inv_pol <- as.polygons(conbuff19_inverse)

cabuff19_inv_sf <- st_as_sf(cabuff19_inv_pol)

#sampling random points from this misshapen california shpfile
sample19 <- st_sample(cabuff19_inv_sf, 609) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample19) +
  tm_dots() +
  tmap_mode("view")

#remove the intersecting polygons

zeros19 <- ms_erase(target = sample19, erase = conbuff19_sf)
 
 #plot to check that there is no overlap
 
 tm_shape(conbuff19_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros19) +
   tm_dots() +
  tmap_mode("view")

zeros19_formatted <- zeros19 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

stack19 <- c(dem, aspect, ter_rug, pop19, lc19, road_dens, road_dist, streams_dist, urban_dist_19, rec_dist, fc_dist_19, fdens, dist_fire18, dist_fire16_17, dist_fire14_15)

#extract data points from these rasters and add them to the shapefile dataframe

#nonconflict points
zero_vars19 <- extract(stack19, zeros19_formatted, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame()

#union conflict points before extracting
con_union19 <- con_19 %>% 
  st_union() %>% 
  vect()

con_var19 <- extract(stack19, con_union19, method = "simple", bind = TRUE, ID = TRUE)

#combine conflict and non-conflict

colnames(zero_vars19) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

colnames(con_var19) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

model_df_19 <- rbind(zero_vars19, con_var19)

#label the year for later binding with other dfs
modeldf_19_year <- model_df_19 %>% 
  mutate(year = 2019)
```

```{r}
#save the file

write.csv(modeldf_19_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_19.csv"), row.names = FALSE)

```


##2020
```{r}

#extract values for 2020, select only conflict indicator and geometry, and dissolve polygons
con_20 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2020) %>% 
  select(conflict, geometry)

con_20_buff <- conflict_buffers %>% 
  filter(year == 2020) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra
conpoints_20_sv <- vect(con_20)
conbuff_20_sv <- vect(con_20_buff)

#read in the CA raster
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure conflict is in the same projection

conpoints20_reproj <- project(conpoints_20_sv,crs(ca_raster))

conbuff20_reproj <- project(conbuff_20_sv,crs(ca_raster))

conpoints20_sf <- st_as_sf(conpoints20_reproj)

conbuff20_sf <- st_as_sf(conbuff20_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out

conbuff20_inverse <- mask(ca_raster, conbuff20_reproj, inverse = TRUE)

tm_shape(conbuff20_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 

cabuff20_inv_pol <- as.polygons(conbuff20_inverse)

cabuff20_inv_sf <- st_as_sf(cabuff20_inv_pol)

#sampling random points from this misshapen california shpfile

sample20 <- st_sample(cabuff20_inv_sf, 799) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample20) +
  tm_dots() +
  tmap_mode("view")

#remove the intersecting polygons

zeros20 <- ms_erase(target = sample20, erase = conbuff20_sf)
 
 #plot to check that there is no overlap
 
 tm_shape(conbuff20_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros20) +
   tm_dots() +
  tmap_mode("view")
 

zeros20_formatted <- zeros20 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

stack20 <- c(dem, aspect, ter_rug, pop20, lc19, road_dens, road_dist, streams_dist, urban_dist_19, rec_dist, fc_dist_19, fdens, dist_fire19, dist_fire17_18, dist_fire15_16)

#extract data points from these rasters and add them to the shapefile dataframe

#nonconflict points
zero_vars20 <- extract(stack20, zeros20_formatted, method = "simple", bind = TRUE, ID = TRUE) %>%
  as.data.frame() 

#union conflict points before extracting
con_union20 <- con_20 %>% 
  st_union() %>% 
  vect()

con_vars20 <- extract(stack20, con_union20, method = "simple", bind = TRUE, ID = TRUE)

#combine conflict and non-conflict

colnames(zero_vars20) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

colnames(con_vars20) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

model_df_20 <- rbind(zero_vars20, con_vars20)

#label the year for later binding with other dfs
modeldf_20_year <- model_df_20 %>% 
  mutate(year = 2020)
```

```{r}
#save the file

write.csv(modeldf_20_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_20.csv"), row.names = FALSE)
```

##2021

```{r}
#extract values for 2016, select only conflict indicator and geometry, and dissolve polygons

con_21 <- conflict_points %>% 
  separate(incdnt_d, into = c("inc_date", "inc_time"), sep = " ") %>% 
  separate(inc_date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(year = as.character.Date(year),
         "type" = cnfrmd_,
         "county" = cnty_nm,
         "conflict" = 1) %>% 
  select(conflict, wir_id:year, type, county, geometry) %>% 
  filter(year == 2021) %>% 
  select(conflict, geometry)

con_21_buff <- conflict_buffers %>% 
  filter(year == 2021) %>% 
  select(conflict, geometry)

#create a spatvector for processing in terra

conpoints_21_sv <- vect(con_21)

conbuff_21_sv <- vect(con_21_buff)

#read in the CA raster
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure conflict is in the same projection
conpoints21_reproj <- project(conpoints_21_sv,crs(ca_raster))

conbuff21_reproj <- project(conbuff_21_sv,crs(ca_raster))

conpoints21_sf <- st_as_sf(conpoints21_reproj)

conbuff21_sf <- st_as_sf(conbuff21_reproj)

#create an inverse mask- Anything withing the conflict buffer shapefiles will be a 0 value. So we get a California raster with all the conflict buffer locations zeroed out

conbuff21_inverse <- mask(ca_raster, conbuff21_reproj, inverse = TRUE)

tm_shape(conbuff21_inverse) +
  tm_raster() +
  tmap_mode("view")

#making the inverse raster a shapefile 
cabuff21_inv_pol <- as.polygons(conbuff21_inverse)

cabuff21_inv_sf <- st_as_sf(cabuff21_inv_pol)

#sampling random points from this misshapen california shpfile
sample21 <- st_sample(cabuff21_inv_sf, 1364) %>% 
  st_as_sf()

#mappping to see what it looks like 
tm_shape(sample21) +
  tm_dots() +
  tmap_mode("view")

#remove the intersecting polygons

zeros21 <- ms_erase(target = sample21, erase = conbuff21_sf)
 
 #plot to check that there is no overlap
 
 tm_shape(conbuff21_sf) +
   tm_polygons(col = "blue") +
  tm_shape(zeros21) +
   tm_dots() +
  tmap_mode("view")

zeros21_formatted <- zeros21 %>% 
  mutate(conflict = 0) %>% 
  select(conflict, geometry) %>% 
  vect()

#create a raster stack of all variables

stack21 <- c(dem, aspect, ter_rug, pop21, lc19, road_dens, road_dist, streams_dist, urban_dist_19, rec_dist, fc_dist_19, fdens, dist_fire20, dist_fire18_19, dist_fire16_17)

#extract data points from these rasters and add them to the shapefile dataframe

#nonconflict points
zero_vars21 <- extract(stack21, zeros21_formatted, method = "simple", bind = TRUE, ID = TRUE) %>% 
  as.data.frame() 

#union conflict points before extracting
con_union21 <- con_21 %>% 
  st_union() %>% 
  vect()

con_vars21 <- extract(stack21, con_union21, method = "simple", bind = TRUE, ID = TRUE)

#combine conflict and non-conflict

colnames(zero_vars21) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

colnames(con_vars21) <- c("conflict", "dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs")

model_df_21 <- rbind(zero_vars21, con_vars21)

#label the year for later binding with other dfs
modeldf_21_year <- model_df_21 %>% 
  mutate(year = 2021)
```

```{r}
#saving the file

write.csv(modeldf_21_year, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_21.csv"), row.names = FALSE)
```

##2022 skipped due to a lack of fire data

#Combine the yearly dataframes

```{r}
#read them in

df16 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_16.csv"))

df17 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_17.csv"))

df18 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_18.csv"))

df19 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_19.csv"))

df20 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_20.csv"))

df21 <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/modeldf_21.csv"))

climate_model_data_allyears <- rbind(df16, df17, df18, df19, df20, df21)

#test that all your years are present

unique(climate_model_data_allyears$year)

```

```{r}
#save the all year data frame

write.csv(climate_model_data_allyears, file = here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/climate_model_data_allyears.csv"), row.names = FALSE)
```


#Run the base model

```{r}
#read in the data
climate_model_data <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/11_10_2022/climate_model_data_allyears.csv"))
```

##All covariates

```{r}
#run the rspf

climate_model_allyears <- rspf(conflict ~ dem + aspect + TRI + popdens + lc + road_dens + road_dist + streams_dist + urban_dist + rec_dist + forest_dist + forest_dens + dist_fire_1yr + dist_fire_23yrs + dist_fire_45yrs, family = "binomial", m = 0, B = 1000, data = climate_model_data)
```

##Jason's 5 (add here later)

```{r}
#save the model

save(climate_model_allyears, file = here("models", "climate_model_allyears.rds"))

```



```{r}
#test dredge to see if the function works
smallmod <- rspf(conflict ~ TRI + popdens, family = "binomial", m = 0, B = 1000, data = climate_model_data)

library(MuMIn)

dredged_model <- dredge(global.model = smallmod, rank = "AIC")

model.sel(dredged_model)

```

