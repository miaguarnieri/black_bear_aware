---
title: "fire_projection_wrangling_RCP8.5"
author: "Claire Meuter"
date: "2023-01-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(beepr)
library(rgeos)
library(rmapshaper)

#claire's file path
gdrive_data <- "/Users/clairemeuter/Library/CloudStorage/GoogleDrive-clairemeuter@ucsb.edu/Shared drives/Black_Bear_Aware/gdrive_data"

```

## Important note: this data is refering to future fire projections for 2024  to 2029 for fire preditions for Isaac Parks work. This fire layer is based on an RCP 8.5 scenario. We also  (for manuscript purposes later ran a 4.5 scenario)

```{r}
# CA Raster example 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#check the coordinate reference system 
crs(ca_raster)
```
Fire layers from Isaac Park from his publication https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0254723#sec015
```{r}
#read in fire layers 

#2024 to 2029 sequence 
fire_pred_2024 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2024_2024LogGam_Class.tif"))

fire_pred_2025 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2025_2025LogGam_Class.tif"))

fire_pred_2026 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2026_2026LogGam_Class.tif"))

fire_pred_2027 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2027_2027LogGam_Class.tif"))

fire_pred_2028 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2028_2028LogGam_Class.tif"))

fire_pred_2029 <- rast(here(gdrive_data, "/InputData/InputData_Files/01_31_23_AnnualFireProjections_Isaac/PredRisk_2029_2029LogGam_Class.tif"))

```

#Getting layers in correct extent, resolution and projection
```{r}
#reproject to the same crs (NAD 83, CA Albers (2011))

fire_pred_2024_albers <- terra::project(fire_pred_2024, ca_raster)

fire_pred_2025_albers <- terra::project(fire_pred_2025, ca_raster)

fire_pred_2026_albers <- terra::project(fire_pred_2026, ca_raster)

fire_pred_2027_albers <- terra::project(fire_pred_2027, ca_raster)

fire_pred_2028_albers <- terra::project(fire_pred_2028, ca_raster)

fire_pred_2029_albers <- terra::project(fire_pred_2029, ca_raster)

```

# cropping the extents to our CA raster 

```{r}
#cropping to spatial extent of CA raster

fire_pred_2024_mask <- mask(fire_pred_2024_albers, ca_raster)

fire_pred_2025_mask <- mask(fire_pred_2025_albers, ca_raster)

fire_pred_2026_mask <- mask(fire_pred_2026_albers, ca_raster)

fire_pred_2027_mask <- mask(fire_pred_2027_albers, ca_raster)

fire_pred_2028_mask <- mask(fire_pred_2028_albers, ca_raster)

fire_pred_2029_mask <- mask(fire_pred_2029_albers, ca_raster)
```

#now I need to reclassify to only keep raster values above .003 (small top amount of proj) I'm calling this high probablity of fire. (this may change) This is our proxy for med/high intensity fires 

```{r}


#list out the from, to values in an object
m <- c(0, 0.03, NA, #values lower than 0.9 to 0
       0.03, 5, 1) #values greater than 0.9 to 1
       
#turn those values into a matrix
mat_fire <- matrix(m, ncol = 3, byrow = TRUE) 

fire_pred_2024_reclassed <- classify(fire_pred_2024_mask, mat_fire,include.lowest=TRUE)
fire_pred_2025_reclassed <- classify(fire_pred_2025_mask, mat_fire,include.lowest=TRUE)
fire_pred_2026_reclassed <- classify(fire_pred_2026_mask, mat_fire,include.lowest=TRUE)
fire_pred_2027_reclassed <- classify(fire_pred_2027_mask, mat_fire,include.lowest=TRUE)
fire_pred_2028_reclassed <- classify(fire_pred_2028_mask, mat_fire,include.lowest=TRUE)
fire_pred_2029_reclassed <- classify(fire_pred_2029_mask, mat_fire,include.lowest=TRUE)
# map to see what it looks like 
#tm_shape(fire_pred_2024_reclassed) +
 # tm_raster() +
  #tmap_mode("view")
```


## Merge layers

```{r}
#4-5 year: combined 2025-2026

fire_pred_2025_reclassed

fire_pred_2026_reclassed

#merge those layers

fire_2025_2026 <- merge(fire_pred_2025_reclassed, fire_pred_2026_reclassed)

#tm_shape(fire_2025_2026) + 
  #tm_raster() + 
 # tmap_mode("view")

#2-3 year: combined 2027-2028

fire_pred_2027_reclassed

fire_pred_2028_reclassed

#merge those layers

fire_2027_2028 <- merge(fire_pred_2027_reclassed, fire_pred_2028_reclassed)

#tm_shape(fire_pred_2029_reclassed) + 
#tm_raster() + 
#tmap_mode("view")

#save the layers

#function for saving multi-year rasters
savemultirast <- function(x){
  
  name <- paste0(deparse(substitute(x)), ".tif") #the name of the file will be the same as the input object, plus '.tif' at the end
  
  #write the raster into the correct folder in drive (the path will need to be updated for other files) and save it as a geotiff
  
  writeRaster(x, filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/proj_fire", name), filetype = "GTiff", overwrite = TRUE)
  
}

#save the data using the function 
savemultirast(fire_2025_2026)

savemultirast(fire_2027_2028)

savemultirast(fire_pred_2029_reclassed)


```
#Fire distance rasters were created in arc gis pro, reading back in here and readjusting extent

```{r}
#Now we need to read back in the distance raster created in ArcGIS pro and mask these layers to match our CA extent again. Layers are already in the correct projection and resolution

# read in the data 
dist_proj_fire_2025_2026 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_proj_fire/dist_proj_fire_2025_2026.tif"))

dist_proj_fire_2027_2028 <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_proj_fire/dist_proj_fire_2027_2028.tif"))

dist_proj_fire_2029 <-rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_proj_fire/dist_proj_fire_2029.tif"))

# Now we need to mask these layers to just the CA extent 

dist_proj_fire_2025_2026_ca <- mask(dist_proj_fire_2025_2026, ca_raster)

dist_proj_fire_2027_2028_ca <- mask(dist_proj_fire_2027_2028, ca_raster)

dist_proj_fire_2029_ca <- mask(dist_proj_fire_2029, ca_raster)

```
#finally, let's save these files to the drive to be referenced later 
```{r}
#write a function to make things easier
saverast <- function(x){
  
  name <- paste0(deparse(substitute(x)), ".tif") #the name of the file will be the same as the input object, plus '.tif' at the end
  
  #write the raster into the correct folder in drive (the path will need to be updated for other files) and save it as a geotiff
  
  writeRaster(x, filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_proj_fire", name), filetype = "GTiff", overwrite = TRUE)
  
}

saverast(dist_proj_fire_2025_2026_ca)

saverast(dist_proj_fire_2027_2028_ca)

saverast(dist_proj_fire_2029_ca)



```

