---
title: "Data Exploration on Public vs Private Lands in California"
author: "Claire Meuter"
date: "2023-03-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(terra)
library(sf)
library(stars)
library(tmap)

#claire's file path
gdrive_data <- "/Users/clairemeuter/Library/CloudStorage/GoogleDrive-clairemeuter@ucsb.edu/Shared drives/Black_Bear_Aware/gdrive_data"
```

## **Introduction:** Here, we explore the relationship between ownership of land and locations of human-black bear conflict in across California. 

## Data wrangling
My data wrangling to-do list:
- Read in my .gdl (geodatabase)
- explore maps
- Add shp files for private land (this source leaves all private land unlabeled, with areas without an ownership feature are ASSUMED to be private (but not included in the dataset as such)).
- intersect my maps 

Reading in land ownership .gdl
```{r}
land_own <- sf::st_read(here(gdrive_data, "/InputData/InputData_Files/2022_CA_ownershipFrap.gdb"), layer = "ownership22_1")

# Checking the class of land_own
class(land_own)
# sf and data.frame

```
Mapping land_own to see what it looks like 
```{r}


#tm_shape(land_own) +
 # tm_polygons() +
  #tmap_options(check.and.fix = TRUE) +
 # tmap_mode("view")
# currently, this map is massive with 52056 obs. I want to combine all of my polygons by the ownership level (Own_Level)
#Using unique(), I see that Own_Level has 7 distinctions, so hopefully at the end of this I'll have 7 multipolygons 
unique(land_own$Own_Level)
# City, County, Federal, Non Profit, Special District, State, Tribal          
```
Simplifying land_own
```{r}
 land_own_sim <- land_own %>% 
  group_by(Own_Level) %>% 
  summarise(Shape = sf::st_union(Shape)) %>% 
  ungroup()
class(land_own_sim)

land_own_sf <- st_as_sf(land_own_sim)
class(land_own_sf)
# This works, but I don't really have an attribute table.. 
plot(land_own_sim)

#looking into recalculating geometrys (like in Arc) 


#saving the new file so I don't have to deal with the larger 
st_write(land_own_sim, dsn = here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own", "land_own_sim.shp"))

# I made this shp into a raster in arc because it was easier (having trouble w/ coding. If I could fix later that'd be cool )

#read in the raster I made in arc 
land_own_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own/own_level_raster/own_level_raster.tif"))

plot(is.na(land_own_raster))



```

# reclassify land_own_raster with NAs as private 
```{r}
# first a little exploration 
unique(land_own_raster$Own_Level)


levels(land_own_raster)




land_own_raster[is.na(land_own_raster[])] <- 0

# value   own level 
#1	City			
#2	County			
#3	Federal			
#4	Non Profit			
#5	`Special District`			
#6	State			
#7	Tribal

cats(land_own_raster_reproj)
 
NAvalue()




#Create reclassification matrix for land own values (from, to)

#list out the from, to values in an object
m <- c(1, 1, #city
       2, 2, #county
       3, 3, #federal
       4, 4, #nonprofit
       5, 5, #special district
       6, 6, #state
       7, 7, #tribal
       NA, 8) #private 

#turn those values into a matrix
mat <- matrix(m, ncol = 2, byrow = TRUE) 

#set categories (labels) for each numeric index

#index vector
index <- c(1, 2, 3, 4, 5, 6, 7, 8)

#categories vector
cats <- c("City", "County", "Federal","Non Profit", "Special District", "State", "Tribal", "Private")

#combine those into a dataframe
catdat <- data.frame(id = index, category = cats)

#Reclassify

#create reclassification function

reclassify <- function(x){
  x_reclassed <- classify(x, mat, others = NA) #reclassify using the matrix above
  
  levels(x_reclassed) <- catdat #then reassign levels (labels) using the dataframe above
  
  return(x_reclassed)
}

#Apply function to each layer



land_own_reclassed <- reclassify(land_own_raster)
plot(land_own_reclassed)

# now land own reclassed needs to be reprojected and clipped the og cal_raster 

#read in holy raster layer 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure raster is in the same projection
land_own_reclass_reproject <- project(land_own_reclassed,ca_raster)

#mask to clear out NAs around california. land_own_mask is the raster i need!
land_own_mask <- mask(land_own_reclass_reproject, ca_raster)

plot(land_own_mask)
#looks beautiful
```

# Find the area of high conflict zone in each type of land 
```{r}
#reading in the high conflict layer 
high_con <- rast(here(gdrive_data, "/AnalysisData/model_outputs/mod3sq_current_highconf.tif"))

#using an extract() function to find values
extract() 
```










```{r}
land_own_no_nas <- sf::st_read(here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own/land_own_sim.shp"))
#reading in the dissolved land ownership shp

 
#some exploration
#class(land_own_no_nas)
# [1] "sf"         "data.frame"

unique(land_own_no_nas$Own_Level)
# unique(land_own_no_nas$geometry)

#read in holy raster layer 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

land_own_vect <- vect(x = land_own_no_nas)
class(land_own_vect)

plot(land_own_vect)
```


##creating CA private land 
```{r}
#Using an inverse mask, anything outside og 
private_land <- mask(ca_raster, land_own_reproj, inverse = TRUE)

tm_shape(private_land) +
  tm_raster() +
  tmap_mode("view")
#convert private land to shp file and combine with land_own_no_nas

private_land_shp <- as.polygons(private_land)

p <- as.data.frame(private_land_shp)
g <- geom(private_land_shp)
head(g) 


g <- geom(private_land_shp, wkt = TRUE)
substr(g, 1, 50)
```

# adding NAs 

# wrtite the similified 
#disignate any nas as public 
# finding area of polygon within other polygons 
```{r}

```


## Our conflict points and public vs private lands

## Our projected high conflict locations and 


# shortcutting here because our meeting is in a few hours and I'm trying to have any results 

# read in the high conflict zones 
```{r}
high_con <- rast(here(gdrive_data, "/AnalysisData/model_outputs/mod3sq_current_highconf.tif"))
#finding the area
as.data.frame(high_con) %>%
  group_by(lyr1) %>%
  tally() %>%
  mutate(area = n * res(high_con)[1] * res(high_con)[2])
# area = 54,955,379	
unique(high_con$lyr1)



#finding the area of land_own_raster_reprojected 
as.data.frame(land_own_raster_reproj) %>%
  tally() %>%
  mutate(area = n * res(land_own_raster_reproj)[1] * res(land_own_raster_reproj)[2])
# area = 219,531,226,282	



```
convert land_own_raster_reproj to shp file 

```{r}
reproj_shp <- as.polygons(land_own_raster_reproj)
```

clip high conflict  by shp file 

```{r}
cropped_high_con <- crop(high_con, reproj_shp)

plot(cropped_high_con)
```
```{r}
#finding the area of the cropped high conflict raster 
as.data.frame(cropped_high_con) %>%
  tally() %>%
  mutate(area = n * res(cropped_high_con)[1] * res(cropped_high_con)[2])
# area = 54,955,379	
```

recalculate high conflict area 
