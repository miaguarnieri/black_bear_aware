---
title: "Data Exploration on Public vs Private Lands in California"
author: "Claire Meuter"
date: "2023-03-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(terra)
library(sf)
library(stars)
library(tmap)

#claire's file path
gdrive_data <- "/Users/clairemeuter/Library/CloudStorage/GoogleDrive-clairemeuter@ucsb.edu/Shared drives/Black_Bear_Aware/gdrive_data"
```

## **Introduction:** Here, we explore the relationship between ownership of land and locations of human-black bear conflict in across California. 

## Data wrangling
My data wrangling to-do list:
- Read in my .gdl (geodatabase)
- explore maps
- Add shp files for private land (this source leaves all private land unlabeled, with areas without an ownership feature are ASSUMED to be private (but not included in the dataset as such)).
- intersect my maps 

Reading in land ownership .gdl
```{r}
land_own <- sf::st_read(here(gdrive_data, "/InputData/InputData_Files/2022_CA_ownershipFrap.gdb"), layer = "ownership22_1")

# Checking the class of land_own
class(land_own)
# sf and data.frame

```
Mapping land_own to see what it looks like 
```{r}


#tm_shape(land_own) +
 # tm_polygons() +
  #tmap_options(check.and.fix = TRUE) +
 # tmap_mode("view")
# currently, this map is massive with 52056 obs. I want to combine all of my polygons by the ownership level (Own_Level)
#Using unique(), I see that Own_Level has 7 distinctions, so hopefully at the end of this I'll have 7 multipolygons 
unique(land_own$Own_Level)
# City, County, Federal, Non Profit, Special District, State, Tribal          
```
Simplifying land_own
```{r}
 land_own_sim <- land_own %>% 
  group_by(Own_Level) %>% 
  summarise(Shape = sf::st_union(Shape)) %>% 
  ungroup()
class(land_own_sim)

land_own_sf <- st_as_sf(land_own_sim)
class(land_own_sf)
# This works, but I don't really have an attribute table.. 
plot(land_own_sim)

#looking into recalculating geometrys (like in Arc) 


#saving the new file so I don't have to deal with the larger 
st_write(land_own_sim, dsn = here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own", "land_own_sim.shp"))

#read in the raster I made in arc 
land_own_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own/own_level_raster/own_level_raster.tif"))

plot(land_own_raster)


```
Now that I have a raste land_own_raster, I want to make a raster layer that represents private land and then merge the rasters together 

```{r}
#read in holy raster layer 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#make sure raster is in the same projection
land_own_raster_reproj <- project(land_own_raster,ca_raster)

land_own_raster_reproj <- ex

#Using an inverse mask, anything outside og 
private_land <- mask(ca_raster, land_own_raster_reproj, inverse = TRUE)

tm_shape(private_land) +
  tm_raster() +
  tmap_mode("view")

#exporting the raster to arcgis so I can visualize it there
writeRaster(private_land, filename = here(gdrive_data, "IntermediateData/IntermediateData_Files/land_own", private_land), filetype = "GTiff", overwrite = TRUE)


```


```{r}
land_own_no_nas <- sf::st_read(here(gdrive_data, "/IntermediateData/IntermediateData_Files/land_own/land_own_sim.shp"))
#reading in the dissolved land ownership shp

 
#some exploration
#class(land_own_no_nas)
# [1] "sf"         "data.frame"

unique(land_own_no_nas$Own_Level)
# unique(land_own_no_nas$geometry)

#read in holy raster layer 
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

land_own_vect <- vect(x = land_own_no_nas)
class(land_own_vect)

plot(land_own_vect)
```

# sorting out attribute table problems 
```{r}
#make sure vect is in the same projection
land_own_reproj <- project(land_own_vect,crs(ca_raster))
crs(land_own_reproj)

land_own_df <- as.data.frame(land_own_reproj, XY = TRUE)

```
##creating CA private land 
```{r}
#Using an inverse mask, anything outside og 
private_land <- mask(ca_raster, land_own_reproj, inverse = TRUE)

tm_shape(private_land) +
  tm_raster() +
  tmap_mode("view")
#convert private land to shp file and combine with land_own_no_nas

private_land_shp <- as.polygons(private_land)

p <- as.data.frame(private_land_shp)
g <- geom(private_land_shp)
head(g) 


g <- geom(private_land_shp, wkt = TRUE)
substr(g, 1, 50)
```

# adding NAs 

# wrtite the similified 
#disignate any nas as public 
# finding area of polygon within other polygons 


## Our conflict points and public vs private lands

## Our projected high conflict locations and 