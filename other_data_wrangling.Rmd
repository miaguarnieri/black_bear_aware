---
title: "Other Data Wrangling"
author: "Mia Guarnieri"
date: '2022-10-19'
output: html_document
---

##Setup and packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#attach packages
#note - Loading all of the ones Jason used, I don't think we will need all of them 

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)

#mia and claire's file path
gdrive_data <- "/Volumes/GoogleDrive/Shared drives/Black_Bear_Aware/gdrive_data"

#sam's file path
#gdrive_data <- "G:/Shared drives/Black_Bear_Aware/gdrive_data"

#chase's file path

```

#Data Wrangling Prior to Coding

*Data Sources*: Please see ReadMe file for metadata and citations.
*Reference Paper*: Insert hagani citation here

#Load in existing data layers

##California raster

Insert info about CA raster layer here

```{r}

ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#plot CA raster to confirm
tm_shape(ca_raster) +
  tm_raster() +
  tmap_mode("view")



```

##Conflict data

Insert info about WIR data here

```{r}

#Buffer conflict points to create conflict raster
# first loading in conflict data 
conflict_points <- read_csv(here(gdrive_data,"/IntermediateData/IntermediateData_Files/2022_07_18_WIRClean_CDFW.csv"))

# Turning conflict_points into a sf object from data frame 

#st_as_sf(conflict_points, coords = "latitude","longitude")
conflict_points_sf <- st_as_sf(conflict_points,coords = c("longitude","latitude"), crs = 4326)
#4326 is code for WGS 84- map does not render properly otherwise, so we need to reproject  to 6414 (NAD83(2011) / California Albers) (but also I think this issue might go away when I remove the error points that are outside CA)

#reprojecting to NAD83(2011) / California Albers
conflict_points_albers <- st_transform(conflict_points_sf,crs = 6414)

#buffering points using SF fuction st_buffer. Units are in meters
conflict_points_buffered <- st_buffer(conflict_points_albers,dist = 5000)

 tm_shape(conflict_points_buffered) +
   tm_dots()+
   tmap_mode("view")

 #need to set conflict crs 
#need to set extent 
#Need to buffer 

#test plot
#how to turn data frame with lat and long columns into an sf object 



# use this if I want to plot
# tm_shape(conflict_points_sf) +
 # tm_dots()+
#  tmap_mode("view")
# class(conflict_points_sf) use this if I need to check class
```

##Elevation (DEM, mean elevation)

Two separate DEM rasters were available at 7.5-arc second resolution from USGS EROS. These will need to be merged togther.

```{r}

#northern California raster

dem_norcal <- rast(here(gdrive_data, "/InputData/InputData_Files/2010_DEM_USGSEROS_Norcal/30n150w_20101117_gmted_mea075.tif"))

#southern California raster

dem_socal <- rast(here(gdrive_data, "/InputData/InputData_Files/2010_DEM_USGSEROS_Socal/30n120w_20101117_gmted_mea075.tif"))

#merging the two rasters

dem_ca <- merge(dem_norcal, dem_socal)

#plot DEM raster
tm_shape(dem_ca) +
  tm_raster() +
  tmap_mode("view")

```

##Road density

```{r}
#road_density_2014 <- rast(here(gdrive_data,"/InputData/InputData_Files/2014_UsaRoadDensity_ESRI/2014_UsaRoadDensity_ESRI.tif"))

#We're no longer using above road_density_2014 layer. Instead we'll read in the roads layer, reproject it, and export it to ArcGIS to use tool line density

#reading in roads polyline: 
roads_2015_tiger <- vect(here(gdrive_data,"/InputData/InputData_Files/2015_roads_TIGER/tl_2015_06_prisecroads.shp"))

#Reprojecting roads layer
albers_roads_2015_tiger <- project(roads_2015_tiger, ca_raster)

#Check coordinate system
crs(albers_roads_2015_tiger)

#export roads density - ONLY NEED TO DO ONCE, HAS BEEN DONE
# writeVector(albers_roads_2015_tiger,filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/2015_roads_TIGER_Formatted/albers_roads_2015_tiger"))


#read in newly created road density. Road density was created in ArcGIS Pro from Roads 2015 Tiger layer. It was created by Claire on 10/23/2022 using the ArcGIS Pro tool line density 

road_density <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/road_density_arc_2022_10_23/road_density.tif"))
```


#Adjust the data to the same geographic extent and projection



##Conflict

```{r}

```

##Elevation
```{r}
#reproject to the same crs (NAD 83, CA Albers (2011)) and resolution (~230 m) as all other data
dem_calbers <- project(dem_ca, ca_raster)

#cropping to the spatial extent of CA
dem_formatted <- mask(dem_calbers, ca_raster)

#save the new file in intermediate data

#function to save rasters, updated with correct filepath

saverast <- function(x){
  
  name <- paste0(deparse(substitute(x)), ".tif") #the name of the file will be the same as the input object, plus '.tif' at the end
  
  #write the raster into the correct folder in drive (the path will need to be updated for other files) and save it as a geotiff
  
  writeRaster(x, filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/Elevation_Formatted", name), filetype = "GTiff", overwrite = TRUE)
  
}

saverast(dem_formatted)

```

##Road density

```{r}


# reproject roads to same crs(NAD 83, CA Albers (2011))
roads_reprojected <- project()
```


## Creating aspect and terrian 
```{r}
#aspect
# reading in elevation data 
elev <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/Elevation_Formatted/dem_formatted.tif"))

aspect <- terrain(elev,v = "aspect",neighbors = 8)
#I think this worked? 

#save the raster

aspect_name <- paste0(deparse(substitute(aspect)), ".tif") #the name of the file will be the same as the input object, plus '.tif' at the end
  
#write the raster into the correct folder in drive (the path will need to be updated for other files) and save it as a geotiff

writeRaster(aspect, filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/aspect", aspect_name), filetype = "GTiff", overwrite = TRUE)


# terrian ruggedness
terrain_ruggedness <- terrain(elev,v = "TRI",neighbors = 8)

#save the raster

tr_name <- paste0(deparse(substitute(terrain_ruggedness)), ".tif") #the name of the file will be the same as the input object, plus '.tif' at the end
  
#write the raster into the correct folder in drive (the path will need to be updated for other files) and save it as a geotiff

writeRaster(terrain_ruggedness, filename = here(gdrive_data, "/IntermediateData/IntermediateData_Files/terrain_ruggedness", tr_name), filetype = "GTiff", overwrite = TRUE)
```

