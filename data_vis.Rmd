---
title: "Data Visualization"
author: "Mia Guarnieri"
date: '2022-11-02'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(terra)
library(tmap)
library(here)
library(sf)
library(ResourceSelection)




#mia, chase, and claire's file path

gdrive_data <- "/Users/mia/Library/CloudStorage/GoogleDrive-mguarnieri@ucsb.edu/Shared drives/Black_Bear_Aware/gdrive_data"

#gdrive_data <- "/Volumes/GoogleDrive/Shared drives/Black_Bear_Aware/gdrive_data"

#sam's file path
#gdrive_data <- "G:/Shared drives/Black_Bear_Aware/gdrive_data"

```

#Base Model

```{r}
#read in the model

model <- load(here(gdrive_data, "/AnalysisData/models/11_29_2022/model_allyears_noclimate/basemodel_allyears.rds")) #you have to name the object "model or it will not read in right

#read in the CA raster

ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

#read in the environmental variables (as close to 2022 as possible)

#elevation
dem <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/elevation/dem_formatted.tif"))

#aspect
aspect <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/aspect/aspect.tif"))

#terrain ruggedness
TRI <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/terrain_ruggedness/terrain_ruggedness.tif"))

#human pop density

popdens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2021_mask.tif"))

#land cover

lc <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc19_reclassed.tif"))

#road density

road_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/road_density/road_density_ca.tif"))

#distance to roads

road_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_road/model_ready/roads15_ca_distance.tif"))

#distance to streams

streams_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_stream/model_ready/stream17_ca_distance.tif"))

#distance to urban areas

urban_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua19_ca_distance.tif"))

#distance to recreational areas

rec_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_rec/model_ready/rec_ca_distance.tif"))

#distance to forest cover

forest_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc19_ca_distance.tif"))

#forest density

forest_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/forest_density/forest_dens_2016_mask.tif"))

stackca_base_rast <- c(dem, aspect, TRI, popdens, lc, road_dens, road_dist, streams_dist, urban_dist, rec_dist, forest_dist, forest_dens)

base_model_data <- read_csv(here(gdrive_data, "/AnalysisData/model_df_noclimate/11_29_2022/model_data_allyears.csv"))

```

```{r}
#changing names of the raster stack to match our model exactly

names(stackca_base_rast) <- c("dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens")

#any categorical variables used need to be identified first

#making land cover categories factors
lc_factors <- as.factor(climate_model_data$lc)

#turning that into a list

f_lc <- levels(lc)

#naming the list "lc" so it matches the model dataframe

names(f_lc) <- "lc"

map <- predict(object = stackca_base_rast, model = basemodel_allyears, fun = predict, factors = f_lc, na.rm = TRUE, type = "response")

plot(map)

#save the map

#writeRaster(map, filename = here(gdrive_data, "/AnalysisData/model_outputs/allyear_base_map.tif"), filetype = "GTiff", overwrite= TRUE)

```

```{r}
#high probability only

top_con <- map

top_con[top_con < 0.7] <- 0

top_con[top_con >= 0.7] <- top_con

plot(top_con)

```


#Climate model maps

```{r}

#read in the model

model<- load(here("models", "robustness_checks", "squares", "sq_mod3climate.rds")) #you have to name the object "model or it will not read in right


#elevation
dem <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/elevation/dem_formatted.tif"))

#aspect
aspect <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/aspect/aspect.tif"))

#terrain ruggedness
TRI <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/terrain_ruggedness/terrain_ruggedness.tif"))

#human pop density

popdens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2021_mask.tif"))

#land cover

lc <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc19_reclassed.tif"))

#road density

road_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/road_density/road_density_ca.tif"))

#distance to roads

road_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_road/model_ready/roads15_ca_distance.tif"))

#distance to streams

streams_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_stream/model_ready/stream17_ca_distance.tif"))

#distance to urban areas

urban_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua19_ca_distance.tif"))

#distance to recreational areas

rec_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_rec/model_ready/rec_ca_distance.tif"))

#distance to forest cover

forest_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc19_ca_distance.tif"))

#forest density

forest_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/forest_density/forest_dens_2016_mask.tif"))


#fire layers

dist_fire_1yr <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire20_ca_distance.tif"))

dist_fire_23yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire18_19_ca_distance.tif"))

dist_fire_45yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire16_17_ca_distance.tif"))

#drought current - historical

drought <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/drought_rasters/UDM_2021/mean_drought_21.tif"))


stackca_clim_rast <- c(dem, aspect, TRI, popdens, lc, road_dens, road_dist, streams_dist, urban_dist, rec_dist, forest_dist, forest_dens, dist_fire_1yr, dist_fire_23yrs, dist_fire_45yrs, drought)

climate_model_data <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/1_31_2023/climate_model_data_allyears.csv"))

```

```{r}

#changing names of the raster stack to match our model exactly

names(stackca_clim_rast) <- c("dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

#any categorical variables used need to be identified first

#making land cover categories factors
lc_factors <- as.factor(climate_model_data$lc)

#turning that into a list

f_lc <- levels(lc)

#naming the list "lc" so it matches the model dataframe

names(f_lc) <- "lc"


#read in ca raster for extent

caraster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

map <- terra::predict(object = stackca_clim_rast, model = mod3climate, fun = predict, factors = f_lc, na.rm = TRUE, type = "response")

#save the map

#writeRaster(map, filename = here(gdrive_data, "/AnalysisData/model_outputs/mod3sq_clim_map.tif"), filetype = "GTiff", overwrite= TRUE)


plot(map, main="Model Predictions")
```


```{r}
current_map <- rast((here(gdrive_data, "/AnalysisData/model_outputs/allyear_clim_map21_v2.tif")))

terra::plot(current_map)
```

#fire model high probability (remember to change this later to incorporate drought)

```{r}
#high probability only

clim_con <- rast(here(gdrive_data, "/AnalysisData/model_outputs/firemod_map.tif"))

top_con_clim <- clim_con

top_con_clim[top_con_clim < 0.7] <- NA

top_con_clim[top_con_clim >= 0.7] <- top_con_clim

plot(top_con_clim)


tm_shape(top_con_clim) +
  tm_raster() +
  tmap_mode("view")


writeRaster(top_con_clim, filename = here(gdrive_data, "/AnalysisData/model_outputs/fire_map_top70.tif"), filetype = "GTiff", overwrite= TRUE)
```


```{r}
#zonal statistics
conflict_points <- read_sf(here(gdrive_data, "/IntermediateData/IntermediateData_Files/conflict_formatted/conflict_points/conflict_points.shp"))


fire_map <- rast(here(gdrive_data, "/AnalysisData/model_outputs/firemod_map.tif"))

tm_shape(fire_map) +
  tm_raster() +
tm_shape(conflict_points) +
  tm_dots() +
  tmap_mode("view")
```

#Data vis with squared model

##Climate model all variables
```{r}
#read in the model

model<- load(here("models", "robustness_checks", "squares", "sq_model_climate_all.rds")) #you have to name the object "model or it will not read in right

#elevation
dem <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/elevation/dem_formatted.tif"))

#aspect
aspect <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/aspect/aspect.tif"))

#terrain ruggedness
TRI <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/terrain_ruggedness/terrain_ruggedness.tif"))

#human pop density

popdens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2021_mask.tif"))

#land cover

lc <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc19_reclassed.tif"))

#road density

road_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/road_density/road_density_ca.tif"))

#distance to roads

road_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_road/model_ready/roads15_ca_distance.tif"))

#distance to streams

streams_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_stream/model_ready/stream17_ca_distance.tif"))

#distance to urban areas

urban_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua19_ca_distance.tif"))

#distance to recreational areas

rec_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_rec/model_ready/rec_ca_distance.tif"))

#distance to forest cover

forest_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc19_ca_distance.tif"))

#forest density

forest_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/forest_density/forest_dens_2016_mask.tif"))


#fire layers

dist_fire_1yr <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire20_ca_distance.tif"))

dist_fire_23yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire18_19_ca_distance.tif"))

dist_fire_45yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire16_17_ca_distance.tif"))

#drought current - historical

drought <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2021/d2021_masked.tif"))


stackca_clim_rast <- c(dem, aspect, TRI, popdens, lc, road_dens, road_dist, streams_dist, urban_dist, rec_dist, forest_dist, forest_dens, dist_fire_1yr, dist_fire_23yrs, dist_fire_45yrs, drought)

climate_model_data <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/12_9_2022/climate_model_data_allyears.csv"))
```

```{r}
#changing names of the raster stack to match our model exactly

names(stackca_clim_rast) <- c("dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

#any categorical variables used need to be identified first

#making land cover categories factors
lc_factors <- as.factor(climate_model_data$lc)

#turning that into a list
f <- as.list(levels(lc_factors))

f_lc <- levels(lc)

caraster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

map <- terra::predict(object = stackca_clim_rast, model = sq_model_climate_all, fun = predict, factors = f_lc, na.rm = TRUE, type = "response")

#save the map

writeRaster(map, filename = here(gdrive_data, "/AnalysisData/model_outputs/allyear_clim_map_squared.tif"), filetype = "GTiff", overwrite= TRUE)

plot(map, main="Model Predictions")
```

#mod 3 climate squared

```{r}
#read in the model

model<- load(here("models", "robustness_checks", "squares", "sq_mod3climate.rds")) #you have to name the object "model or it will not read in right

#elevation
dem <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/elevation/dem_formatted.tif"))

#aspect
aspect <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/aspect/aspect.tif"))

#terrain ruggedness
TRI <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/terrain_ruggedness/terrain_ruggedness.tif"))

#human pop density

popdens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/population_density/pop_den_2021_mask.tif"))

#land cover

lc <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/land_cover/lc19_reclassed.tif"))

#road density

road_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/road_density/road_density_ca.tif"))

#distance to roads

road_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_road/model_ready/roads15_ca_distance.tif"))

#distance to streams

streams_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_stream/model_ready/stream17_ca_distance.tif"))

#distance to urban areas

urban_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_urban/model_ready/ua19_ca_distance.tif"))

#distance to recreational areas

rec_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_rec/model_ready/rec_ca_distance.tif"))

#distance to forest cover

forest_dist <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/distance_rasters/dist_to_forest/model_ready/fc19_ca_distance.tif"))

#forest density

forest_dens <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/forest_density/forest_dens_2016_mask.tif"))


#fire layers

dist_fire_1yr <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire20_ca_distance.tif"))

dist_fire_23yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire18_19_ca_distance.tif"))

dist_fire_45yrs <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/model_ready/dist_fire/fire16_17_ca_distance.tif"))

#drought current - historical

drought <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/drought/us_drought_monitor/2021/d2021_masked.tif"))


stackca_clim_rast <- c(dem, aspect, TRI, popdens, lc, road_dens, road_dist, streams_dist, urban_dist, rec_dist, forest_dist, forest_dens, dist_fire_1yr, dist_fire_23yrs, dist_fire_45yrs, drought)

climate_model_data <- read_csv(here(gdrive_data, "/AnalysisData/model_df_climate/12_9_2022/climate_model_data_allyears.csv"))
```

```{r}
#changing names of the raster stack to match our model exactly

names(stackca_clim_rast) <- c("dem", "aspect", "TRI", "popdens", "lc", "road_dens", "road_dist", "streams_dist", "urban_dist", "rec_dist", "forest_dist", "forest_dens", "dist_fire_1yr", "dist_fire_23yrs", "dist_fire_45yrs", "drought")

#any categorical variables used need to be identified first

#making land cover categories factors
lc_factors <- as.factor(climate_model_data$lc)

#turning that into a list
f <- as.list(levels(lc_factors))

f_lc <- levels(lc)

caraster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))

map <- terra::predict(object = stackca_clim_rast, model = mod3climate, fun = predict, factors = f_lc, na.rm = TRUE, type = "response")

#save the map

writeRaster(map, filename = here(gdrive_data, "/AnalysisData/model_outputs/mod3clim_map_squared.tif"), filetype = "GTiff", overwrite= TRUE)

plot(map, main="Model Predictions")
```


#Model table

```{r}
library(stringr)
library(ggplot2)


coeff_table <- as.data.frame(mod3climate$coefficients)

colnames(coeff_table) <- "Coefficient"

coeff_nonlc <- coeff_table %>% 
  filter(row.names(coeff_table !grepl('lc')))
```

