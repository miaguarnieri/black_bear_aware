---
title: "Projection Data"
author: "Chase Tarr"
date: "2023-01-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#attach packages
#note - Loading all of the ones Jason used, I don't think we will need all of them 

library(tidyverse)
library(here)
library(terra)
library(sf)
library(tmap)
library(beepr)
library(rgeos)
library(rmapshaper)
library(raster)
library(stars)
library(purrr)
library(remotes)
library(dplyr)
library(data.table)

#mia and claire's and Chase's file path
gdrive_data <- "/Volumes/GoogleDrive/Shared drives/Black_Bear_Aware/gdrive_data"

#sam's file path
#gdrive_data <- "G:/Shared drives/Black_Bear_Aware/gdrive_data"
```

```{r}
install_github("Sibada/scPDSI")

```

```{r}
library(scPDSI)
```



```{r}
ca_raster <- rast(here(gdrive_data, "/IntermediateData/IntermediateData_Files/CARaster_Tiger_Formatted/formattedcaraster.tif"))
```

# Read in drought data

```{r}
CalAdapt_PE <- rast(here(gdrive_data, "/InputData/InputData_Files/Drought/CalAdapt/data-5/et_month_HadGEM2-CC_rcp45_2006-01.v0.CA_NV.tif")) %>% 
  terra::project(ca_raster)
```

Precip
```{r}
CalAdapt_P <- rast(here(gdrive_data, "/InputData/InputData_Files/Drought/CalAdapt/data-5/rainfall_month_CCSM4_rcp45_2006-01.v0.CA_NV.tif")) %>% 
  terra::project(ca_raster)
```

Potential Evap
```{r}
caladapt_calbers <- terra::project(CalAdapt, ca_raster)

#mask to CA
caladapt_masked <- mask(caladapt_calbers, ca_raster)

#test plot
#plot(caladapt_masked)
```

```{r}
caladapt_rain_calbers <- terra::project(CalAdapt_rain, ca_raster)

#mask to CA
caladapt_rain_masked <- mask(caladapt_rain_calbers, ca_raster)

#test plot
plot(caladapt_rain_masked)

```


# Making P the rain value, and PE the potential Evap value from caladapt downloaded data and putting into one dataframe

```{r}
rain_df <- as.data.frame(caladapt_rain_masked)

evap_df <- as.data.frame(caladapt_masked)


#p_pe_binded <- bind_rows(rain_df, evap_df)

#dataframe we will use
p_pe_cbinded <- cbind(rain_df, evap_df)

#reanaming columns
P_PE <- p_pe_cbinded %>% 
  rename(
    P = "rainfall_month_CCSM4_rcp45_2006-01.v0.CA_NV",
    PE = "et_month_HadGEM2-CC_rcp45_2006-01.v0.CA_NV")
#P_PE <- na.omit(P_PE)

P_PE_filt <- P_PE %>% 
  filter(between(P, 0.5,1),
         between(PE, 0.3,0.6))

setDT(P_PE_filt)
```



```{r}
.onLoad <- function(libname, pkgname) {
  ops <- options()
  pdsi.ops <- list(
    # Calculating the conventional PDSI
    # Duration factors
    PDSI.p = 0.897,
    PDSI.q = 1/3,

    # Coefficients of climate characteristic
    PDSI.coe.K1.1 = 1.5,
    PDSI.coe.K1.2 = 2.8,
    PDSI.coe.K1.3 = 0.5,

    PDSI.coe.K2 = 17.67
  )

  toset <- !(names(pdsi.ops) %in% names(ops))
  if(any(toset)) {
    options(pdsi.ops[toset])
  }
}

test <- .onLoad
```

```{r}
options(PDSI.coe.K1.1 = 1.6)
options(PDSI.coe.K1.3 = 0.4)
options(PDSI.coe.K2 = 16.84)
options(PDSI.p = 0.755)
options(PDSI.q = 1/1.63)
#gb_pdsi <- pdsi(P, PE, start = 1960, sc = FALSE)
#lines(gb_pdsi$X, col = 'red')
```

calculation in the pdsi: 
\deqn{Ki0=coeK11 * lg(((PEi+Ri+ROi)/(Pi+Li)+coeK12)/Di)+coeK13}
\deqn{Ki=coeK2/(\sum Dj*Kj) * Ki}
\deqn{X[i]=p*X[i-1]+q*Z[i]}


```{r}
C_pdsi <- function(P, PE, AWC, s_yr, e_yr, calib_s_yr, calib_e_yr, sc, K1_1, K1_2, K1_3, K2, p, q) {
    .Call('_scPDSI_C_pdsi', PACKAGE = 'scPDSI', P, PE, AWC, s_yr, e_yr, calib_s_yr, calib_e_yr, sc, K1_1, K1_2, K1_3, K2, p, q)
}
```

```{r}
#AWC = 100

pdsi <- function(P, PE, AWC = 100, start = NULL, end = NULL, cal_start = NULL, cal_end = NULL,
                 sc = TRUE) {

  freq <- 12

  if(is.null(start)) start <-  1;
  if(is.null(end)) end <- start + ceiling(length(P)/freq) - 1

  if(is.null(cal_start)) cal_start <- start
  if(is.null(cal_end)) cal_end <- end

  res <- C_pdsi(P, PE, AWC, start, end, cal_start, cal_end, sc,
                getOption("PDSI.coe.K1.1"),
                getOption("PDSI.coe.K1.2"),
                getOption("PDSI.coe.K1.3"),
                getOption("PDSI.coe.K2"),
                getOption("PDSI.p"),
                getOption("PDSI.q"))

  names(res) <- c("inter.vars", "clim.coes", "calib.coes")

  inter.vars <- res[[1]]
  clim.coes <- res[[2]]
  calib.coes <- res[[3]]
  inter.vars[inter.vars == -999.] <- NA

  out <- list(call = match.call(expand.dots=FALSE),
              X = stats::ts(inter.vars[, 14], start = start, frequency = freq),
              inter.vars = stats::ts(inter.vars[, 3:13], start = start, frequency = freq))

  colnames(out$inter.vars) <- c("P", "PE", "PR", "PRO", "PL", "d", "Z",
                                "Prob", "X1", "X2", "X3")

  dim(calib.coes) <- c(2, 5)
  colnames(calib.coes) <- c("m", "b", "p", "q", "K2")
  rownames(calib.coes) <- c('wet', 'dry')

  colnames(clim.coes) <- c("alpha", "beta", "gamma", "delta", "K1")
  rownames(clim.coes) <- month.name

  out$clim.coes <- clim.coes
  out$calib.coes <- calib.coes

  class(out) <- "pdsi"
  out
}

```


```{r}
test <- pdsi(P, PE, start = 2006)#AWC = 100, start = NULL, end = NULL, cal_start = 1, cal_end = 1,
                 #sc = TRUE)

plot(test)
```

```{r}
av <- available.packages(filters=list())
av[av[, "PACKAGE"] == pkg, ]
```


#example code used online
```{r}
data(P_PE)

P <- P_PE$P
PE <- P_PE$PE
sc_pdsi_P_PE <- pdsi(P, PE, start = 2006)
#stop here for pdsi (x) values

plot(sc_pdsi) # plot PDSI
plot(sc_pdsi, index = "PHDI") # plot PHDI
plot(sc_pdsi, index = "WPLM") # plot weighted PDSI

# Without self-calibrating.
ori_pdsi <- pdsi(P, PE, start = 2006, sc = FALSE)
plot(ori_pdsi)

# Without self-calibrating and use standards of
# mainland China. (GB/T 20481-2017)
options(PDSI.coe.K1.1 = 1.6)
options(PDSI.coe.K1.3 = 0.4)
options(PDSI.coe.K2 = 16.84)
options(PDSI.p = 0.755)
options(PDSI.q = 1/1.63)
gb_pdsi <- pdsi(P, PE, start = 1960, sc = FALSE)
plot(gb_pdsi)
```

```{r}
pdsi_merged <- terra::merge(sc_pdsi_P_PE[[2]], sc_pdsi_P_PE[[3]], sc_pdsi_P_PE[[4]], sc_pdsi_P_PE[[5]])

pdsi_rast <- rast(pdsi_merged)

#reproject
pdsi_calbers <- terra::project(pdsi_rast, ca_raster)

#mask to CA
pdsi_masked <- mask(pdsi_calbers, ca_raster)
```




```{r}
library(scPDSI)
data(Lubuge)

 P <- Lubuge$P
 PE <- Lubuge$PE
 lubugesc_pdsi <- pdsi(P, PE, start = 1960)
 plot(lubugesc_pdsi$X)

 # Without self-calibrating.
 ori_pdsi <- pdsi(P, PE, start = 1960, sc = FALSE)
 plot(ori_pdsi$X)

 # Without self-calibrating and use standards of
 # mainland China. (GB/T 20481-2006)
 options(PDSI.coe.K1.1 = 1.6)
 options(PDSI.coe.K1.3 = 0.4)
 options(PDSI.coe.K2 = 16.84)
 options(PDSI.p = 0.755)
 options(PDSI.q = 1/1.63)
 gb_pdsi <- pdsi(P, PE, start = 1960, sc = FALSE)
 lines(gb_pdsi$X, col = 'red')

```


```{r}
require(raster)


  

shp.PE <- rasterToPolygons(CalAdapt_P)

#ca_vector <- as.polygons(ca_raster)

PE_calbers <- terra::project(shp.PE, ca_raster)

rec_areas_PEP_mask <- crop(rec_areas_PEP_calbers, ca_raster)

rec_areas_PEP_raster <- rasterize(rec_areas_PEP_mask, ca_raster)

#mask to CA
caladapt_masked <- mask(caladapt_calbers, ca_raster)

r.to.poly<-rasterToPolygons(rs, dissolve = T)

int.r <-raster::intersect(r.to.poly,shp) 

proj4string(shp) <- proj4string(r.to.poly)
```


